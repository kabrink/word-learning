---
title: "Word Learning"
author: "Kimberly A. Brink"
date: "March 9, 2016"
output: html_document
---

"Word Learning" is a study that assesses whether children will selectively trust a robot that provides accurate information compared to a robot that provides inaccurate information. Children watch two robots name a series of familiar objects, where one robot always names the object correctly and the other robot always incorrectly names the robot. The two robots are distingushed by their colors. 

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.path='Figures/', dev=c('png','postscript'), fig.width = 8, fig.height = 8, echo=FALSE, warning=FALSE, message=FALSE)
```

```{r standard_error}
s.error <- function(x) sd(x,na.rm=TRUE)/sqrt(length(x))
```

```{r libraries}
library(lubridate)
library(pander)
options("scipen"=100, "digits"= 4)
```

```{r import}
#Import results from qualtrics using the qualtrics API (username, token, and surveyID removed)
#https://api.qualtrics.com/

 version = '2.5' #qualtrics version
 request = 'getLegacyResponseData' #Returns all of the response data for a survey in the original (legacy) data format.
 username = #hidden
 token = #hidden
 format = 'CSV' #comma-separated value format
 surveyID = #hidden
 exportTags = '1' #f 1 (true) the export tags will be used rather than the V labels. The default is 0.
 labels = '1' #If 1 (true) the label for choices and answers will be used and not the id. The default is 0.
 UnansweredRecode = '-99' #missing value coding
 
 #function that imports all responses from the qualtrics website and saves it to a data frame
 getSurveyResults <- function (version, request, username, token, format, surveyid,exportTags,labels)
 {
     url = paste("https://umich.qualtrics.com//WRAPI/ControlPanel/api.php?API_SELECT=ControlPanel", 
                 '&Version=', version,
                 '&Request=', request,
                 '&User=', username,
                 '&Token=', token,
                 '&Format=', format,
                 "&SurveyID=", surveyid,
                 "&ExportTags=", exportTags,
                 "&Labels=", labels,
                 "&UnansweredRecode=-99",sep='')
 
     t = read.csv(url)
     for (i in 1:10){ names(t)[i] <- as.character(t[1,i]) }
     t<-t[-1,]
 }
 
#save messy data to qualtrics.WL data frame
qualtrics.WL <- getSurveyResults(version, request, username, token, format, surveyID, exportTags, labels)
```

```{r formatting}
#Clean the data set

#Subset the data set by condition (i.e., by the order in which the robots are presented and by which robot is accurate)
WL.A <- subset(qualtrics.WL, Condition==1 & AccurateRobot=='Purple')
WL.B <- subset(qualtrics.WL, Condition==2 & AccurateRobot=='Purple')
WL.C <- subset(qualtrics.WL, Condition==1 & AccurateRobot=='Orange')
WL.D <- subset(qualtrics.WL, Condition==2 & AccurateRobot=='Orange')

#Each condition of the survey has different question names for the same questions. 
#Remove all unused variable names from each condition

WL.A <- WL.A[, c("ResponseID","StartDate","Finished","Condition","AccurateRobot","Subject","Sex","DOB","DOT","Fam1","Fam1_TEXT","Fam2","Fam2_TEXT","Fam3","Fam3_TEXT","Fam4","Fam4_TEXT","EJ1","Ask1A","Ask1A_TEXT","Ask1B","Ask1C","Ask2A","Ask2A_TEXT","Ask2B","Ask2C","Ask3A","Ask3A_TEXT","Ask3B","Ask3C","Ask4A","Ask4A_TEXT","Ask4B","Ask4C","EJ2","WHYCHOOSE","WHY","CANDY","CHOOSE","THINK","MORAL","PAIN","FEELINGS","SCARED","HUNGRY","P.SEX","O.SEX","OLDER","Audio_file","Comments")] 

WL.B <- WL.B[, c("ResponseID","StartDate","Finished","Condition","AccurateRobot","Subject","Sex","DOB","DOT","Fam1.2","Fam1_TEXT.2","Fam2.2","Fam2_TEXT.2","Fam3.2","Fam3_TEXT.2","Fam4.2","Fam4_TEXT.2","EJ1.2","Ask1A.1","Ask1A_TEXT.1","Ask1B.1","Ask1C.1","Ask2A.1","Ask2A_TEXT.1","Ask2B.1","Ask2C.1","Ask3A.1","Ask3A_TEXT.1","Ask3B.1","Ask3C.1","Ask4A.1","Ask4A_TEXT.1","Ask4B.1","Ask4C.1","EJ2.1","WHYCHOOSE","WHY","CANDY","CHOOSE","THINK","MORAL","PAIN","FEELINGS","SCARED","HUNGRY","P.SEX","O.SEX","OLDER","Audio_file","Comments")]

WL.C <- WL.C[, c("ResponseID","StartDate","Finished","Condition","AccurateRobot","Subject","Sex","DOB","DOT","Fam1.1","Fam1_TEXT.1","Fam2.1","Fam2_TEXT.1","Fam3.1","Fam3_TEXT.1","Fam4.1","Fam4_TEXT.1","EJ1.1","Ask1A","Ask1A_TEXT","Ask1B","Ask1C","Ask2A","Ask2A_TEXT","Ask2B","Ask2C","Ask3A","Ask3A_TEXT","Ask3B","Ask3C","Ask4A","Ask4A_TEXT","Ask4B","Ask4C","EJ2","WHYCHOOSE","WHY","CANDY","CHOOSE","THINK","MORAL","PAIN","FEELINGS","SCARED","HUNGRY","P.SEX","O.SEX","OLDER","Audio_file","Comments")] 

WL.D <- WL.D[, c("ResponseID","StartDate","Finished","Condition","AccurateRobot","Subject","Sex","DOB","DOT","Fam1.3","Fam1_TEXT.3","Fam2.3","Fam2_TEXT.3","Fam3.3","Fam3_TEXT.3","Fam4.3","Fam4_TEXT.3","EJ1.3","Ask1A.1","Ask1A_TEXT.1","Ask1B.1","Ask1C.1","Ask2A.1","Ask2A_TEXT.1","Ask2B.1","Ask2C.1","Ask3A.1","Ask3A_TEXT.1","Ask3B.1","Ask3C.1","Ask4A.1","Ask4A_TEXT.1","Ask4B.1","Ask4C.1","EJ2.1","WHYCHOOSE","WHY","CANDY","CHOOSE","THINK","MORAL","PAIN","FEELINGS","SCARED","HUNGRY","P.SEX","O.SEX","OLDER","Audio_file","Comments")]

#Rename all variables so that they have the same names across conditions
names(WL.A) <- c("ResponseID","StartDate","Finished","Condition","AccurateRobot","Subject","Sex","DOB","DOT","Fam1","Fam1_TEXT","Fam2","Fam2_TEXT","Fam3","Fam3_TEXT","Fam4","Fam4_TEXT","EJ1","Ask1A","Ask1A_TEXT","Ask1B","Ask1C","Ask2A","Ask2A_TEXT","Ask2B","Ask2C","Ask3A","Ask3A_TEXT","Ask3B","Ask3C","Ask4A","Ask4A_TEXT","Ask4B","Ask4C","EJ2","WHYCHOOSE","WHY","CANDY","CHOOSE","THINK","MORAL","PAIN","FEELINGS","SCARED","HUNGRY","P.SEX","O.SEX","OLDER","Audio_file","Comments")

names(WL.B) <- c("ResponseID","StartDate","Finished","Condition","AccurateRobot","Subject","Sex","DOB","DOT","Fam1","Fam1_TEXT","Fam2","Fam2_TEXT","Fam3","Fam3_TEXT","Fam4","Fam4_TEXT","EJ1","Ask1A","Ask1A_TEXT","Ask1B","Ask1C","Ask2A","Ask2A_TEXT","Ask2B","Ask2C","Ask3A","Ask3A_TEXT","Ask3B","Ask3C","Ask4A","Ask4A_TEXT","Ask4B","Ask4C","EJ2","WHYCHOOSE","WHY","CANDY","CHOOSE","THINK","MORAL","PAIN","FEELINGS","SCARED","HUNGRY","P.SEX","O.SEX","OLDER","Audio_file","Comments")

names(WL.C) <- c("ResponseID","StartDate","Finished","Condition","AccurateRobot","Subject","Sex","DOB","DOT","Fam1","Fam1_TEXT","Fam2","Fam2_TEXT","Fam3","Fam3_TEXT","Fam4","Fam4_TEXT","EJ1","Ask1A","Ask1A_TEXT","Ask1B","Ask1C","Ask2A","Ask2A_TEXT","Ask2B","Ask2C","Ask3A","Ask3A_TEXT","Ask3B","Ask3C","Ask4A","Ask4A_TEXT","Ask4B","Ask4C","EJ2","WHYCHOOSE","WHY","CANDY","CHOOSE","THINK","MORAL","PAIN","FEELINGS","SCARED","HUNGRY","P.SEX","O.SEX","OLDER","Audio_file","Comments")

names(WL.D) <- c("ResponseID","StartDate","Finished","Condition","AccurateRobot","Subject","Sex","DOB","DOT","Fam1","Fam1_TEXT","Fam2","Fam2_TEXT","Fam3","Fam3_TEXT","Fam4","Fam4_TEXT","EJ1","Ask1A","Ask1A_TEXT","Ask1B","Ask1C","Ask2A","Ask2A_TEXT","Ask2B","Ask2C","Ask3A","Ask3A_TEXT","Ask3B","Ask3C","Ask4A","Ask4A_TEXT","Ask4B","Ask4C","EJ2","WHYCHOOSE","WHY","CANDY","CHOOSE","THINK","MORAL","PAIN","FEELINGS","SCARED","HUNGRY","P.SEX","O.SEX","OLDER","Audio_file","Comments")

#Add a new variable to each data set which contains the condition name for each participant
WL.A$Order = "A"
WL.B$Order = "B"
WL.C$Order = "C"
WL.D$Order = "D"

#Combine all data into one dataset
WL <- rbind(WL.A,WL.B,WL.C,WL.D)
```

```{r preprocessing}
#Set all missing values to NA
WL[ WL == "" ] = NA
WL[ WL == -99 ] = NA


WL[WL$Subject == "010AnA",]$DOB = '06/13/2012' #error in experimenter data entry

#Convert categorical variables to factors
WL$AccurateRobot = factor(WL$AccurateRobot)
WL$EJ1 = factor(WL$EJ1)
WL$EJ2 = factor(WL$EJ2)

WL$Ask1B = factor(WL$Ask1B)
WL$Ask2B = factor(WL$Ask2B)
WL$Ask3B = factor(WL$Ask3B)
WL$Ask4B = factor(WL$Ask4B)

WL$Ask1C = factor(WL$Ask1C)
WL$Ask2C = factor(WL$Ask1C)
WL$Ask3C = factor(WL$Ask3C)
WL$Ask4C = factor(WL$Ask4C)
```

```{r variables}
#Convert date variables to a format that can be processed by R
WL$DOB = mdy(WL$DOB)
WL$DOT = mdy(WL$DOT)

#Calculate the age of each participant in months
WL$Age = year(as.period(interval(WL$DOB, WL$DOT)))*12 + month(as.period(interval(WL$DOB, WL$DOT))) + day(as.period(interval(WL$DOB, WL$DOT)))/30

WL$AgeYears = WL$Age/12

#Calculate whether children accurately answered all familiarization trials.
WL$Fam.Match = ifelse(WL$Fam1=="Brush",1,0) + ifelse(WL$Fam2=="Doll",1,0) + ifelse(WL$Fam3=="Ball",1,0) + ifelse(WL$Fam4=="Bear",1,0)

#Calculate the proportion of answers where children accurately determined which robot was bad at naming the familiar objects 
WL$EJ.Match = (ifelse(WL$EJ1!=WL$AccurateRobot,1,0) + ifelse(WL$EJ2!=WL$AccurateRobot,1,0))/2

#Calculate the proportion of answers where children said they would ask the accurate robot for the name of the novel object
WL$Ask.Match = (ifelse(WL$Ask1B==WL$AccurateRobot,1,0) + ifelse(WL$Ask2B==WL$AccurateRobot,1,0) + ifelse(WL$Ask3B==WL$AccurateRobot,1,0) + ifelse(WL$Ask4B==WL$AccurateRobot,1,0))/4

WL$Ask.bin = factor(ifelse(WL$Ask.Match <= mean(WL$Ask.Match,na.rm=T), 0, 1))

#Calculate the proportion of answers where children chose the same name that the accurate robot chose
WL$Word.Match = (ifelse(WL$Ask1C==WL$AccurateRobot,1,0) + ifelse(WL$Ask2C==WL$AccurateRobot,1,0) + ifelse(WL$Ask3C==WL$AccurateRobot,1,0) + ifelse(WL$Ask4C==WL$AccurateRobot,1,0))/4

WL$Word.bin = factor(ifelse(WL$Word.Match <= mean(WL$Word.Match,na.rm=T), 0, 1))

```
 
##Demographics
```{r demographics}
#calculate the number of females in the sample
isGirl <- WL$Sex == "Female"
```

There are `r dim(WL)[1]` participants.

The average age of the sample is `r round(mean(WL$Age), digits = 2)` months.

The median age of the sample is `r round(median(WL$Age), digits = 2)` months.

The minimum age of the sample is `r round(min(WL$Age), digits = 2)` months.

The maximum age of the sample is `r round(max(WL$Age), digits = 2)` months.

There are `r sum(isGirl)` females in the sample.

The first date of test was `r min(WL$DOT)`.

The most recent date of test was `r max(WL$DOT)`.


```{r descriptives}
#calculate summary statistics for age of sample
panderOptions("digits", 4)
pander(summary(WL$Age), caption = 'Age(months)')
hist(WL$Age,main='',xlab='Age(months)')

pander(summary(WL$AgeYears), caption = 'Age(years)')
hist(WL$AgeYears, main='',xlab='Age(years)')

#report how many participants completed each order of the survey
pander(table(WL$Order),caption = 'Distribution by Order of Presentation')
```

##Performance during accuracy trials 
```{r accuracy_trials}
#report summary statistics for performance during familiarization/accuracy trials
pander(summary(WL$Fam.Match))
hist(WL$Fam.Match,main='',xlab='Num correct')
pander(table(WL$Fam.Match),caption='Participant Count by Number of Trials Correct')
```

```{r familiarization_error}
#Remove all participants that failed to correctly answer all four familiarization trials
WL = WL[which(WL$Fam.Match==4),]
```
Now there are `r dim(WL)[1]` participants after removing for familiarization errors. 

#Comparisons with chance for three test questions.
```{r performance}
#Report summary statistics for accuracy on judgment questions
pander(summary(WL$EJ.Match), caption='Proportion of Explicit Judgment Questions Correct')
hist(WL$EJ.Match,main='',xlab='Proportion of explicit judgment correct')

#Report summary statistics for accuracy on ask questions
pander(summary(WL$Ask.Match),caption='Proportion of Ask Questions correct')
hist(WL$Ask.Match,main='',xlab='Proportion of Ask Questions correct')

#Report summary statistics for accuracy on endorse questions
pander(summary(WL$Word.Match), caption = 'Proportion of Endorsement Questions correct')
hist(WL$Word.Match, main='',xlab='Proportion of Endorsement Questions correct')

#Compare performance to chance guessing
EJ.ttest = t.test(WL$EJ.Match,mu=.5) # Ho: mu=0.5
Ask.ttest = t.test(WL$Ask.Match,mu=.5)
Word.ttest = t.test(WL$Word.Match,mu=.5)

chance.table = data.frame(Question = c('Explicit judgment','Ask','Endorse'), 
                          Proportion = c(
                            paste(round(EJ.ttest$estimate,2),
                                  '(',round(s.error(WL$EJ.Match),2),')',sep=''), 
                            paste(round(Ask.ttest$estimate,2),
                                  '(',round(s.error(WL$Ask.Match),2),')',sep=''),
                            paste(round(Word.ttest$estimate,2),
                                  '(',round(s.error(WL$Word.Match),2),')',sep='')), 
                          't(df)' = c(
                            paste(round(EJ.ttest$statistic,2),
                                  '(',round(EJ.ttest$parameter,2),')',sep=''), 
                            paste(round(Ask.ttest$statistic,2),
                                  '(',round(Ask.ttest$parameter,2),')',sep=''),
                            paste(round(Word.ttest$statistic,2),
                                  '(',round(Word.ttest$parameter,2),')',sep='')),
                          '95%CI' = c(paste(round(EJ.ttest$conf.int[1],2),
                                             round(EJ.ttest$conf.int[2],2),sep=","),
                                       paste(round(Ask.ttest$conf.int[1],2),
                                             round(Ask.ttest$conf.int[2],2),sep=","),
                                       paste(round(Word.ttest$conf.int[1],2),
                                             round(Word.ttest$conf.int[2],2),sep=","))
                          )

pander(chance.table,style = 'rmarkdown')

#For future rmarkdown pdf use
# \begin{center}
#   \begin{tabular}{lccc}
#     \hline
#     Question & Proportion & t(`r EJ.ttest$parameter`) & 95\% CI\\
#     \hline
#     'Explicit judgment' & `r round(EJ.ttest$estimate,2)`(`r round(s.error(WL$EJ.Match),2)`) & `r round(EJ.ttest$statistic,2)` & `r round(EJ.ttest$conf.int,2)` \\
#     Ask & `r round(Ask.ttest$estimate,2)`(`r round(s.error(WL$Ask.Match),2)`) & `r round(Ask.ttest$statistic,2)` & `r round(Ask.ttest$conf.int,2)` \\
#     Endorse & `r round(Word.ttest$estimate,2)`(`r round(s.error(WL$Word.Match),2)`) & `r round(Word.ttest$statistic,2)` & `r round(Word.ttest$conf.int,2)` \\
#   \end{tabular}
# \end{center}
```


```{r predictors}
#Recode perceptions of agency and experience questions
WL$THINK.score = ifelse(WL$THINK=="No",0,ifelse(WL$THINK=="A little bit",1,ifelse(WL$THINK=="A medium amount",2,ifelse(WL$THINK=="A lot",3,NA))))
WL$MORAL.score = ifelse(WL$MORAL=="No",0,ifelse(WL$MORAL=="A little bit",1,ifelse(WL$MORAL=="A medium amount",2,ifelse(WL$MORAL=="A lot",3,NA))))
WL$CHOOSE.score = ifelse(WL$CHOOSE=="No",0,ifelse(WL$CHOOSE=="A few things",1,ifelse(WL$CHOOSE=="A medium amount of things",2,ifelse(WL$CHOOSE=="A lot of things",3,NA))))
WL$PAIN.score = ifelse(WL$PAIN=="No",0,ifelse(WL$PAIN=="A little bit",1,ifelse(WL$PAIN=="A medium amount",2,ifelse(WL$PAIN=="A lot",3,NA))))
WL$SCARED.score = ifelse(WL$SCARED=="No",0,ifelse(WL$SCARED=="A little bit",1,ifelse(WL$SCARED=="A medium amount",2,ifelse(WL$SCARED=="A lot",3,NA))))
WL$HUNGRY.score = ifelse(WL$HUNGRY=="No",0,ifelse(WL$HUNGRY=="A little bit",1,ifelse(WL$HUNGRY=="A medium amount",2,ifelse(WL$HUNGRY=="A lot",3,NA))))

#Calculate aggregates of children's perceptions of the robots' agency and experience
WL$AgIndex = (WL$THINK.score + WL$MORAL.score + WL$CHOOSE.score)/3
WL$ExpIndex = (WL$PAIN.score + WL$SCARED.score + WL$HUNGRY.score)/3
WL$AgIndex.cent = scale(WL$AgIndex,center=T,scale=F)
WL$ExpIndex.cent = scale(WL$ExpIndex,center=T,scale=F)
```

```{r correlations}
#Calculate correlations between aggregates and test questions
plot(jitter(WL$ExpIndex),jitter(WL$AgIndex))
cor.test(WL$AgIndex,WL$ExpIndex)

plot(jitter(WL$Word.Match),jitter(WL$AgIndex))
cor.test(WL$Word.Match,WL$AgIndex)

plot(jitter(WL$Ask.Match),jitter(WL$AgIndex))
cor.test(WL$Ask.Match,WL$AgIndex)

plot(jitter(WL$EJ.Match),jitter(WL$AgIndex))
cor.test(WL$EJ.Match,WL$AgIndex)

plot(jitter(WL$Word.Match),jitter(WL$ExpIndex))
cor.test(WL$Word.Match,WL$ExpIndex)

plot(jitter(WL$Ask.Match),jitter(WL$ExpIndex))
cor.test(WL$Ask.Match,WL$ExpIndex)

plot(jitter(WL$EJ.Match),jitter(WL$ExpIndex))
cor.test(WL$EJ.Match,WL$ExpIndex)
```

```{r classification_plots}
plot(WL$Ask.bin,WL$AgIndex)
plot(WL$Word.bin,WL$AgIndex)
plot(WL$Ask.bin,WL$ExpIndex)
plot(WL$Word.bin,WL$ExpIndex)
plot(jitter(WL$ExpIndex),jitter(WL$AgIndex),col=(ifelse(WL$Ask.bin==1,'red','blue')), main = "Binary Ask Match")
plot(jitter(WL$ExpIndex),jitter(WL$AgIndex),col=(ifelse(WL$Word.bin==1,'red','blue')), main = "Binary Word Match")
```

##Regression Analyses
```{r regressions}
#assess which predictors predict responses to test questions
summary(glm(EJ.Match~ExpIndex.cent+AgIndex.cent+Age,data=WL))
summary(glm(Ask.Match~ExpIndex.cent+AgIndex.cent+Age,data=WL))
summary(glm(Word.Match~ExpIndex.cent+AgIndex.cent+Age,data=WL))

summary(glm(Ask.bin~ExpIndex.cent+AgIndex.cent+Age+Sex+Order+AccurateRobot,data=WL,family="binomial"))
summary(glm(Word.bin~ExpIndex.cent+AgIndex.cent+Age+Sex+Order+AccurateRobot,data=WL,family="binomial"))

summary(glm(Ask.bin~ExpIndex.cent+AgIndex.cent+Age,data=WL,family="binomial"))
summary(glm(Word.bin~ExpIndex.cent+AgIndex.cent+Age,data=WL,family="binomial"))
```
